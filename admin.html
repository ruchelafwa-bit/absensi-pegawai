  <!doctype html>
  <html lang="id">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>Panel Admin</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  </head>
  <body class="bg-cover bg-center min-h-screen" style="background-image: url('imigrasi.jpg');">
    <div class="bg-white/90 min-h-screen">
      <div class="max-w-7xl mx-auto p-4">

        <!-- Header -->
        <header class="flex justify-between items-center mb-6">
          <div class="flex items-center gap-3">
            <img src="logouptimi.png" alt="Logo" class="h-12 w-12 object-contain rounded" />
            <h1 class="text-2xl font-bold text-blue-900">Panel Admin</h1>
          </div>
          <div class="flex gap-2">
            <button id="exportBtn" class="px-3 py-1 bg-green-600 text-white rounded-lg hover:bg-green-700">Export CSV</button>
            <button id="exportExcelBtn" class="px-3 py-1 bg-emerald-600 text-white rounded-lg hover:bg-emerald-700">Export Excel</button>
            <button id="logoutBtn" class="px-3 py-1 bg-red-600 text-white rounded-lg hover:bg-red-700">Logout</button>
          </div>
        </header>

        <!-- Filter -->
        <div class="mb-4 flex flex-wrap gap-3 items-end">
          <div>
            <label class="block text-sm">Filter Tanggal</label>
            <input type="date" id="filterDate" class="border rounded p-1" />
          </div>
          <div>
            <label class="block text-sm">Filter Bulan</label>
            <input type="month" id="filterMonth" class="border rounded p-1" />
          </div>
          <div>
            <label class="block text-sm">Nama Pegawai</label>
            <input type="text" id="filterName" placeholder="Cari nama..." class="border rounded p-1" />
          </div>
          <div>
            <label class="block text-sm">Dari Tanggal</label>
            <input type="date" id="filterStart" class="border rounded p-1" />
          </div>
          <div>
            <label class="block text-sm">Sampai Tanggal</label>
            <input type="date" id="filterEnd" class="border rounded p-1" />
          </div>

          <button id="applyFilter" class="px-3 py-1 bg-blue-600 text-white rounded hover:bg-blue-700">Terapkan</button>
          <button id="resetFilter" class="px-3 py-1 bg-gray-500 text-white rounded hover:bg-gray-600">Reset</button>
        </div>

        <!-- Statistik Kehadiran -->
        <div id="statsPanel" class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
          <div class="p-4 bg-green-100 rounded-xl shadow text-center">
            <h3 class="text-lg font-bold text-green-700">Total Kehadiran</h3>
            <p id="statTotal" class="text-3xl font-extrabold text-green-800">0</p>
            <p id="statTanggal" class="text-sm text-gray-500"></p>
          </div>
          <div class="p-4 bg-blue-100 rounded-xl shadow text-center">
            <h3 class="text-lg font-bold text-blue-700">Tepat Waktu</h3>
            <p id="statHadir" class="text-3xl font-extrabold text-blue-800">0</p>
            <p class="text-sm text-gray-500">Hadir 06:00â€“07:59</p>
          </div>
          <div class="p-4 bg-red-100 rounded-xl shadow text-center">
            <h3 class="text-lg font-bold text-red-700">Terlambat</h3>
            <p id="statTelat" class="text-3xl font-extrabold text-red-800">0</p>
            <p class="text-sm text-gray-500">â‰¥ 08:00</p>
          </div>
        </div>

        <!-- Tabel absensi -->
        <div class="bg-white shadow rounded-xl p-6 mb-6">
          <h2 class="text-lg font-semibold mb-4">Data Absensi</h2>
          <div class="overflow-x-auto">
            <table class="w-full text-sm border">
              <thead class="bg-gray-100">
                <tr>
                  <th class="p-2 border">#</th>
                  <th class="p-2 border">Nama</th>
                  <th class="p-2 border">Tanggal</th>
                  <th class="p-2 border">Waktu</th>
                  <th class="p-2 border">Status</th>
                  <th class="p-2 border">Foto</th>
                </tr>
              </thead>
              <tbody id="absensiTable"></tbody>
            </table>
          </div>
        </div>

        <!-- Rekap Mingguan -->
        <div class="bg-white shadow rounded-xl p-6 mb-6">
          <h2 class="text-lg font-semibold mb-4">Rekap Mingguan</h2>
          <div class="overflow-x-auto">
            <table class="w-full text-sm border">
              <thead class="bg-gray-100">
                <tr>
                  <th class="p-2 border">Nama</th>
                  <th class="p-2 border">Hadir</th>
                  <th class="p-2 border">Terlambat</th>
                  <th class="p-2 border">Total</th>
                </tr>
              </thead>
              <tbody id="rekapMingguan"></tbody>
            </table>
          </div>
        </div>

        <!-- Rekap Bulanan -->
        <div class="bg-white shadow rounded-xl p-6 mb-6">
          <h2 class="text-lg font-semibold mb-4">Rekap Bulanan</h2>
          <div class="overflow-x-auto">
            <table class="w-full text-sm border">
              <thead class="bg-gray-100">
                <tr>
                  <th class="p-2 border">Nama</th>
                  <th class="p-2 border">Hadir</th>
                  <th class="p-2 border">Terlambat</th>
                  <th class="p-2 border">Total</th>
                </tr>
              </thead>
              <tbody id="rekapBulanan"></tbody>
            </table>
          </div>
        </div>

        <!-- Ranking Kehadiran -->
        <div class="bg-white shadow rounded-xl p-6 mb-6">
          <h2 class="text-lg font-semibold mb-4">Ranking Kehadiran</h2>
          <ol id="rankingList" class="list-decimal list-inside space-y-1"></ol>
        </div>

        <!-- Grafik Kehadiran -->
        <div class="bg-white shadow rounded-xl p-6 mt-6">
          <h2 class="text-lg font-semibold mb-4">Grafik Kehadiran</h2>
          <canvas id="chartMingguan" class="mb-6 max-h-64"></canvas>
          <canvas id="chartBulanan" class="max-h-64"></canvas>
        </div>
      </div>
    </div>

    <!-- Modal Foto -->
    <div id="photoModal" class="fixed inset-0 bg-black/70 hidden items-center justify-center z-50">
      <div class="bg-white p-4 rounded shadow max-w-lg">
        <img id="modalImg" src="" class="max-h-[80vh] max-w-full rounded"/>
        <button id="closeModal" class="mt-3 px-4 py-2 bg-red-600 text-white rounded">Tutup</button>
      </div>
    </div>

  <script>
  console.log("ADMIN JS LOADED âœ…");

  /* ----------- Konfigurasi ----------- */
  const API_URL = "https://script.google.com/macros/s/AKfycbxNfiHHMQ_taEm16P1AmyrGbj7PUa9memchAG44YnnCAOYTBsSL0petWT_jUBnpDxKx/exec";

  /* ----------- Elemen DOM ----------- */
  const absensiTable = document.getElementById("absensiTable");
  const rankingList = document.getElementById("rankingList");
  const filterDate = document.getElementById("filterDate");
  const filterMonth = document.getElementById("filterMonth");
  const filterName = document.getElementById("filterName");
  const filterStart = document.getElementById("filterStart");
  const filterEnd = document.getElementById("filterEnd");
  const applyFilterBtn = document.getElementById("applyFilter");
  const resetFilterBtn = document.getElementById("resetFilter");
  const exportBtn = document.getElementById("exportBtn");
  const exportExcelBtn = document.getElementById("exportExcelBtn");
  const logoutBtn = document.getElementById("logoutBtn");
  const photoModal = document.getElementById("photoModal");
  const modalImg = document.getElementById("modalImg");
  const closeModalBtn = document.getElementById("closeModal");

  /* ----------- State ----------- */
  window.absensiData = []; // semua data yang diambil dari sheet
  let filteredData = [];    // data setelah filter (digunakan utk render)

  /* ----------- Helper ----------- */
  function getToday() {
    return new Date().toISOString().slice(0,10);
  }
  function formatTimeFromTimestamp(ts) {
    try {
      return new Date(ts).toLocaleTimeString("id-ID");
    } catch(e) { return ts || ""; }
  }

  /* ----------- API: Ambil & Simpan ----------- */
  async function ambilAbsensi() {
  try {
    const res = await fetch(API_URL);
    const json = await res.json();   // { success, data }

    if (!json.success || !Array.isArray(json.data)) {
      throw new Error("Format API salah!");
    }

    window.absensiData = json.data.map(item => ({
      id: item.id || "",
      name: item.nama || "",
      date: item.tanggal ? item.tanggal.slice(0, 10) : "", // âœ… potong jadi YYYY-MM-DD
      time: item.waktu || "",
      status: item.status || "",
      photo: item.foto || "",
      timestamp: (item.tanggal && item.waktu)
        ? `${item.tanggal.slice(0,10)}T${item.waktu}`
        : ""
    }));

  } catch (err) {
    alert("Gagal membaca data dari Spreadsheet!");
    console.error("ERROR ambilAbsensi:", err);
    window.absensiData = [];
  }
}

  async function simpanAbsensi(record) {
    try {
      const res = await fetch(API_URL, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({
          nama: record.name,
          tanggal: record.date,
          waktu: record.time,
          status: record.status || ""
        })
      });

      // Periksa respons server
      if (!res.ok) {
        const text = await res.text().catch(()=>"");
        throw new Error(`HTTP ${res.status} - ${text}`);
      }

      // coba parse respons JSON bila ada (beberapa Apps Script mengembalikan JSON)
      const txt = await res.text();
      try {
        const j = txt ? JSON.parse(txt) : null;
        console.log("RESPON SIMPAN:", j);
      } catch (e) {
        console.log("RESPON SIMPAN (non-json):", txt);
      }

      // refresh data setelah simpan
      await ambilAbsensi();
      applyCurrentFilter(); // refresh view
    } catch (err) {
      console.error("Gagal simpan ke Sheet:", err);
      alert("Gagal menyimpan ke Google Sheets. Cek console untuk detail.");
    }
  }

  /* ----------- Render functions (1x each) ----------- */
  function renderTable(data) {
    absensiTable.innerHTML = "";
    if (!data || data.length === 0) {
      absensiTable.innerHTML = `<tr><td colspan="6" class="text-center p-4 text-gray-500 italic">Belum ada data absensi</td></tr>`;
      return;
    }

    data.forEach((r, i) => {
      const timeStr = r.timestamp ? formatTimeFromTimestamp(r.timestamp) : (r.time || "");
      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td class="border p-1">${i + 1}</td>
        <td class="border p-1">${escapeHtml(r.name)}</td>
        <td class="border p-1">${escapeHtml(r.date)}</td>
        <td class="border p-1">${escapeHtml(timeStr)}</td>
        <td class="border p-1 ${r.status === "Hadir" ? "text-green-600" : "text-red-600"}">${escapeHtml(r.status)}</td>
        <td class="border p-1">
          ${r.photo ? `<img src="${escapeAttr(r.photo)}" data-photo="${escapeAttr(r.photo)}" class="w-16 h-16 rounded object-cover cursor-pointer"/>` : '-'}
        </td>
      `;
      absensiTable.appendChild(tr);
    });

    // photo modal
    document.querySelectorAll("[data-photo]").forEach(img => {
      img.onclick = () => {
        modalImg.src = img.dataset.photo;
        photoModal.classList.remove("hidden");
        photoModal.classList.add("flex");
      };
    });
  }

  function renderRanking(data) {
    const hadirCounts = {};
    data.forEach(r => {
      if (r.status === "Hadir") {
        hadirCounts[r.name] = (hadirCounts[r.name] || 0) + 1;
      }
    });
    const ranking = Object.entries(hadirCounts).sort((a,b)=> b[1] - a[1]);
    rankingList.innerHTML = "";
    if (ranking.length === 0) {
      rankingList.innerHTML = `<li class="text-gray-500 italic">Belum ada ranking</li>`;
      return;
    }
    ranking.forEach(([name,count], idx) => {
      let medal = "";
      if (idx===0) medal="ðŸ¥‡ ";
      else if (idx===1) medal="ðŸ¥ˆ ";
      else if (idx===2) medal="ðŸ¥‰ ";
      const li = document.createElement("li");
      li.textContent = `${medal}${name} - ${count}x Hadir`;
      rankingList.appendChild(li);
    });
  }

  function renderStats(data, label="") {
    document.getElementById("statTanggal").textContent = label;
    const total = data.length;
    const hadir = data.filter(r => r.status === "Hadir").length;
    const telat = data.filter(r => r.status === "Terlambat").length;
    document.getElementById("statTotal").textContent = total;
    document.getElementById("statHadir").textContent = hadir;
    document.getElementById("statTelat").textContent = telat;
  }

  function renderRekap(records, targetId) {
    const counts = {};
    records.forEach(r => {
      if (!counts[r.name]) counts[r.name] = { hadir:0, telat:0 };
      if (r.status === "Hadir") counts[r.name].hadir++;
      if (r.status === "Terlambat") counts[r.name].telat++;
    });
    const tbody = document.getElementById(targetId);
    tbody.innerHTML = "";
    Object.entries(counts).forEach(([name,data])=>{
      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td class="border p-1">${escapeHtml(name)}</td>
        <td class="border p-1 text-green-600">${data.hadir}</td>
        <td class="border p-1 text-red-600">${data.telat}</td>
        <td class="border p-1 font-bold">${data.hadir + data.telat}</td>
      `;
      tbody.appendChild(tr);
    });
  }

  let weekChart = null;
  let monthChart = null;
  function renderCharts(records) {
    if (weekChart) weekChart.destroy();
    if (monthChart) monthChart.destroy();

    const dailyCounts = {};
    records.forEach(r => {
      dailyCounts[r.date] = (dailyCounts[r.date] || 0) + 1;
    });

    const labels = Object.keys(dailyCounts).sort();
    const values = labels.map(l => dailyCounts[l]);

    const ctxWeek = document.getElementById("chartMingguan").getContext("2d");
    weekChart = new Chart(ctxWeek, {
      type: "bar",
      data: { labels, datasets: [{ label: "Jumlah Kehadiran", data: values }] },
      options: { responsive:true, maintainAspectRatio:false }
    });

    const hadir = records.filter(r=> r.status==="Hadir").length;
    const telat = records.filter(r=> r.status==="Terlambat").length;
    const ctxMonth = document.getElementById("chartBulanan").getContext("2d");
    monthChart = new Chart(ctxMonth, {
      type: "doughnut",
      data: { labels: ["Tepat Waktu","Terlambat"], datasets: [{ data: [hadir, telat] }] },
      options: { responsive:true, maintainAspectRatio:false }
    });
  }

  /* ----------- Filters & helpers ----------- */
  function applyCurrentFilter() {
    // derive filteredData from window.absensiData and UI fields
    let records = (window.absensiData || []).slice();

    const name = (filterName.value || "").trim().toLowerCase();
    if (name) {
      records = records.filter(r => (r.name || "").toLowerCase().includes(name));
    }

    const start = filterStart.value;
    const end = filterEnd.value;
    if (start && end) {
      records = records.filter(r => r.date >= start && r.date <= end);
    } else if (filterMonth.value) {
      const [y,m] = filterMonth.value.split("-");
      records = records.filter(r => (r.date || "").startsWith(`${y}-${m}`));
    } else if (filterDate.value) {
      records = records.filter(r => r.date === filterDate.value);
    } else {
      // default: today
      const today = getToday();
      records = records.filter(r => r.date === today);
    }

    filteredData = records;
    // update UI
    const label = (start && end) ? `Dari ${new Date(start).toLocaleDateString("id-ID")} s/d ${new Date(end).toLocaleDateString("id-ID")}` :
                  (filterMonth.value ? `Bulan ${filterMonth.value.split("-")[1]}/${filterMonth.value.split("-")[0]}` :
                  (filterDate.value ? new Date(filterDate.value).toLocaleDateString("id-ID") : "Hari ini"));

    renderTable(filteredData);
    renderRanking(filteredData);
    renderStats(filteredData, label);
    renderRekap(filteredData, "rekapMingguan");
    renderRekap(filteredData, "rekapBulanan");
    renderCharts(filteredData);
  }

  /* ----------- Export ----------- */
  exportBtn.onclick = () => {
    const records = filteredData.length ? filteredData : (window.absensiData || []);
    if (!records.length) return alert("Belum ada data absensi!");
    const header = ["Nama","Tanggal","Waktu","Status"];
    const rows = records.map(r => {
      const timeStr = r.timestamp ? formatTimeFromTimestamp(r.timestamp) : (r.time || "");
      return [r.name, r.date, timeStr, r.status];
    });
    function quoteCsvField(f) {
    if (f === undefined || f === null) return '""';
    const s = String(f).replace(/"/g, '""');
    return `"${s}"`;
  }
  const csvRows = [header, ...rows].map(row => row.map(quoteCsvField).join(","));
  const csvContent = csvRows.join("\n");

    const blob = new Blob([csvContent], { type: "text/csv;charset=utf-8;" });
    const url = URL.createObjectURL(blob);
    const link = document.createElement("a");
    link.href = url;
    link.download = `absensi_${new Date().toISOString().slice(0,10)}.csv`;
    link.click();
  };

  exportExcelBtn.onclick = () => {
    const records = filteredData.length ? filteredData : (window.absensiData || []);
    if (!records.length) return alert("Belum ada data absensi!");
    const worksheetData = records.map(r => ({
      Nama: r.name,
      Tanggal: r.date,
      Waktu: r.timestamp ? formatTimeFromTimestamp(r.timestamp) : (r.time || ""),
      Status: r.status
    }));
    const ws = XLSX.utils.json_to_sheet(worksheetData);
    const wb = XLSX.utils.book_new();
    XLSX.utils.book_append_sheet(wb, ws, "Absensi");
    XLSX.writeFile(wb, `absensi_${new Date().toISOString().slice(0,10)}.xlsx`);
  };

  /* ----------- Modal / UI events ----------- */
  closeModalBtn.onclick = () => {
    photoModal.classList.add("hidden");
    photoModal.classList.remove("flex");
  };
  logoutBtn.onclick = () => {
    sessionStorage.removeItem("isAdmin");
    window.location.href = "login.html";
  };

  /* Filter buttons */
  applyFilterBtn.onclick = () => applyCurrentFilter();
  resetFilterBtn.onclick = () => {
    filterDate.value = "";
    filterMonth.value = "";
    filterName.value = "";
    filterStart.value = "";
    filterEnd.value = "";
    filterDate.value = getToday();
    applyCurrentFilter();
  };

  /* escape helpers to avoid injection */
  function escapeHtml(s) {
    if (s === undefined || s === null) return "";
    return String(s).replace(/[&<>"']/g, function(m){ return ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'})[m]; });
  }
  function escapeAttr(s) {
    if (s === undefined || s === null) return "";
    return String(s).replace(/"/g, '&quot;');
  }

  /* ----------- Init application (async safe) ----------- */
  async function initApp() {
    console.log("INIT APP DIJALANKAN âœ…");
    // if (sessionStorage.getItem("isAdmin") !== "true") {
//   window.location.href = "login.html";
//   return;
// }


    filterDate.value = getToday();

    await ambilAbsensi();
    applyCurrentFilter(); // will render everything based on default filter (today)

    // make charts responsive height
    document.getElementById("chartMingguan").style.height = "240px";
    document.getElementById("chartBulanan").style.height = "240px";
  }

  // start when DOM ready
  window.addEventListener("DOMContentLoaded", () => {
    initApp().catch(err => console.error(err));
  });

  </script>

  </body>
  </html>

